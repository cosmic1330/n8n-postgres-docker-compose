networks:
  db_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

services:
  # ===============================
  # PostgreSQL Primary
  # ===============================
  postgres:
    image: postgres:18
    container_name: postgres
    restart: always
    networks:
      db_net:
        ipv4_address: 172.25.0.5
    # 移除直接對外埠口映射以增強資安
    # ports:
    #   - "${DATABASE_PORT}:5432"
    deploy:
      resources:
        limits:
          cpus: "0.50"
          memory: 1G
    volumes:
      - ./postgres/.data/db:/var/lib/postgresql/18.1/data
      - ./init-db.sh:/docker-entrypoint-initdb.d/init-db.sh
      - ./postgres/ssl/server.crt:/var/lib/postgresql/18.1/docker/server.crt:ro
      - ./postgres/ssl/server.key:/var/lib/postgresql/18.1/docker/server.key:ro
      - ./postgres/ssl/root.crt:/var/lib/postgresql/18.1/docker/root.crt:ro
    env_file:
      - .env
    environment:
      POSTGRES_USER: ${DATABASE_USERNAME}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
      POSTGRES_DB: ${DATABASE_NAME}
      PGDATA: /var/lib/postgresql/18.1/data
    command: >
      postgres
      -c wal_level=replica
      -c max_wal_senders=10
      -c max_replication_slots=10
      -c hot_standby=on
      -c ssl=on
      -c ssl_cert_file=/var/lib/postgresql/18.1/docker/server.crt
      -c ssl_key_file=/var/lib/postgresql/18.1/docker/server.key
      -c ssl_ca_file=/var/lib/postgresql/18.1/docker/root.crt

  # ===============================
  # PostgreSQL Replica (大幅修正)
  # ===============================
  postgres-replica:
    image: postgres:18
    container_name: postgres-replica
    restart: always
    networks:
      - db_net
    ports:
      - "${REPLICA_DATABASE_PORT}:5432"
    deploy:
      resources:
        limits:
          cpus: "0.50"
          memory: 1G
    depends_on:
      - postgres
    env_file:
      - .env
    environment:
      # 這裡不需要設定 POSTGRES_USER/PASSWORD，因為資料是直接從 Primary 複製過來的
      # 它會連同 Primary 的帳號密碼一起複製過來
      PGDATA: /var/lib/postgresql/18.1/data
    volumes:
      # 資料掛載
      - ./postgres-replica/.data/db:/var/lib/postgresql/18.1/data
      # 掛載 SSL 憑證
      - ./postgres/ssl/server.crt:/var/lib/postgresql/18.1/docker/server.crt:ro
      - ./postgres/ssl/server.key:/var/lib/postgresql/18.1/docker/server.key:ro
      - ./postgres/ssl/root.crt:/var/lib/postgresql/18.1/docker/root.crt:ro
      # 掛載我們寫的初始化腳本
      - ./init-replica.sh:/init-replica.sh
    # 覆蓋 Entrypoint，改用我們的腳本
    entrypoint: ["/bin/bash", "/init-replica.sh"]

  # ===============================
  # PgBouncer for n8n（session）
  # ===============================
  pgbouncer-n8n:
    image: edoburu/pgbouncer
    container_name: pgbouncer-n8n
    restart: always
    networks:
      - db_net
    environment:
      DB_HOST: 172.25.0.5
      DB_PORT: 5432
      DB_USER: ${N8N_DB_USER}
      DB_PASSWORD: ${N8N_DB_PASSWORD}
      DB_NAME: ${N8N_DB_NAME}
      AUTH_TYPE: scram-sha-256

      POOL_MODE: session
      MAX_CLIENT_CONN: 20
      DEFAULT_POOL_SIZE: 5
      SERVER_RESET_QUERY: DISCARD ALL
      SERVER_TLS_SSLMODE: require
    depends_on:
      - postgres

  # ===============================
  # PgBouncer for App（寫入）
  # ===============================
  pgbouncer-app:
    image: edoburu/pgbouncer
    container_name: pgbouncer-app
    restart: always
    networks:
      - db_net
    environment:
      DB_HOST: 172.25.0.5
      DB_PORT: 5432
      DB_USER: ${APP_WRITE_DB_USER}
      DB_PASSWORD: ${APP_WRITE_DB_PASSWORD}
      DB_NAME: ${APP_WRITE_DB_NAME}
      AUTH_TYPE: scram-sha-256

      POOL_MODE: transaction
      MAX_CLIENT_CONN: 500
      DEFAULT_POOL_SIZE: 40
      RESERVE_POOL_SIZE: 10
      SERVER_RESET_QUERY: DISCARD ALL
      SERVER_TLS_SSLMODE: require
    depends_on:
      - postgres

  # ===============================
  # nginx
  # ===============================
  nginx:
    image: nginx:latest
    networks:
      - db_net
    ports:
      - "443:443"
    volumes:
      - ./nginx/templates:/etc/nginx/templates:ro
      - ./nginx/ssl:/var/www/html/ssl
      - ./nginx/.well-known/pki-validation:/var/www/html/.well-known/pki-validation
    environment:
      - DOMAIN_NAME=${DOMAIN_NAME}
    depends_on:
      - n8n

  # ===============================
  # n8n
  # ===============================
  n8n:
    image: jui/n8n
    build:
      context: .
      dockerfile: Dockerfile
    container_name: n8n
    restart: always
    networks:
      - db_net
    # 移除直接對外埠口映射，改由 Nginx (443) 存取
    # ports:
    #   - "5678:5678"
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 2G
    # ### 新增這段：強制使用穩定 DNS ###
    dns:
      - 8.8.8.8
      - 1.1.1.1
    # ############################
    environment:
      - N8N_SECURE_COOKIE=false
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=pgbouncer-n8n
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=${N8N_DB_USER}
      - DB_POSTGRESDB_PASSWORD=${N8N_DB_PASSWORD}
      - N8N_COMMUNITY_PACKAGES_ALLOW_TOOL_USAGE=true
      - NODE_FUNCTION_ALLOW_EXTERNAL=*
      - GENERIC_TIMEZONE=Asia/Taipei
      - TZ=Asia/Taipei
      - N8N_HOST=${DOMAIN_NAME}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - WEBHOOK_URL=https://${DOMAIN_NAME}/

    # 添加必要的權限給 Chrome/Puppeteer
    cap_add:
      - SYS_ADMIN
    security_opt:
      - seccomp:unconfined
    links:
      - postgres
    volumes:
      - ./n8n/data:/home/node/.n8n
    depends_on:
      - pgbouncer-n8n

  # ===============================
  # API Bridge (外部存取窗口)
  # ===============================
  api-bridge:
    build:
      context: ./app
    container_name: api-bridge
    restart: always
    networks:
      - db_net
    environment:
      - DB_HOST=postgres-replica
      - DB_PORT=5432
      - DB_NAME=${APP_READ_DB_NAME}
      - DB_USER=${APP_READ_DB_USER}
      - DB_PASSWORD=${APP_READ_DB_PASSWORD}
      - API_SECRET_KEY=${API_SECRET_KEY}
      - DB_SSL_CA=/etc/ssl/postgres/root.crt
      - DB_SSL_CERT=/etc/ssl/postgres/client.crt
      - DB_SSL_KEY=/etc/ssl/postgres/client.key
    volumes:
      - ./postgres/ssl/root.crt:/etc/ssl/postgres/root.crt:ro
      - ./postgres/ssl/client.crt:/etc/ssl/postgres/client.crt:ro
      - ./postgres/ssl/client.key:/etc/ssl/postgres/client.key:ro
    depends_on:
      - postgres-replica
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 512M

  # ===============================
  # PostgreSQL Backup (Sidecar)
  # ===============================
  postgres-backup:
    image: postgres:18
    container_name: postgres-backup
    restart: always
    networks:
      - db_net
    environment:
      - DB_HOST=postgres
      - DB_NAME=${APP_WRITE_DB_NAME}
      - POSTGRES_USER=${DATABASE_USERNAME}
      - POSTGRES_PASSWORD=${DATABASE_PASSWORD}
    volumes:
      - ./backups:/backups
      - ./scripts/backup-db.sh:/usr/local/bin/backup-db.sh:ro
    # 執行週期：每 24 小時備份一次
    entrypoint: |
      /bin/sh -c '
      while true; do
        /usr/local/bin/backup-db.sh
        echo "Sleeping for 24 hours..."
        sleep 86400
      done'
    depends_on:
      - postgres
